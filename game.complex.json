{
  "meta": {
    "title": "Complex Expression Test",
    "version": 1
  },
  "resources": {
    "capacity": 10
  },
  "stats": {
    "hp": { "cur": 50, "max": 50 },
    "mp": { "cur": 30, "max": 30 },
    "stamina": { "cur": 12, "max": 12 },
    "strength": { "cur": 14, "max": 20 },
    "intelligence": { "cur": 16, "max": 20 },
    "armor": { "cur": 5, "max": 20 },
    "gold": { "cur": 100, "max": 9999 },
    "xp": { "cur": 0, "max": 1000 },
    "level": { "cur": 1, "max": 10 }
  },
  "items": {
    "health_potion": {
      "name": "Health Potion",
      "stackable": true,
      "start_count": 3,
      "use_effects": [
        { "type": "stat_add", "stat": "hp", "value_expr": "floor($stat.hp.max * 0.3)" },
        { "type": "log", "text": "Restored 30% of max HP." }
      ]
    },
    "mana_potion": {
      "name": "Mana Potion",
      "stackable": true,
      "start_count": 2,
      "use_effects": [
        { "type": "stat_add", "stat": "mp", "value_expr": "ceil($stat.mp.max / 3)" },
        { "type": "log", "text": "Restored 1/3 of max MP." }
      ]
    },
    "power_ring": {
      "name": "Power Ring",
      "stackable": true,
      "start_count": 0,
      "hold_buffs": [
        { "buff": "power_boost", "value_expr": "$count * 3 + 2" }
      ]
    },
    "magic_amulet": {
      "name": "Magic Amulet",
      "stackable": true,
      "start_count": 0,
      "hold_buffs": [
        { "buff": "magic_boost", "value_expr": "floor($count * 2.5)" },
        { "buff": "mp_regen", "value_expr": "$count" }
      ]
    },
    "guardian_shield": {
      "name": "Guardian Shield",
      "stackable": false,
      "start_count": 0,
      "hold_buffs": [
        { "buff": "armor_boost", "value_expr": "5" },
        { "buff": "damage_reduction", "value_expr": "floor($stat.armor.cur * 0.1)" }
      ]
    },
    "cursed_blade": {
      "name": "Cursed Blade",
      "stackable": false,
      "start_count": 0,
      "hold_buffs": [
        { "buff": "power_boost", "value_expr": "10" },
        { "buff": "curse", "value_expr": "floor($stat.hp.max * 0.05)" }
      ]
    },
    "lucky_coin": {
      "name": "Lucky Coin",
      "stackable": true,
      "start_count": 1,
      "hold_buffs": [
        { "buff": "luck", "value_expr": "$count" }
      ]
    },
    "experience_tome": {
      "name": "Tome of Experience",
      "stackable": true,
      "start_count": 0,
      "use_effects": [
        { "type": "stat_add", "stat": "xp", "value_expr": "50 + $stat.level.cur * 10" },
        { "type": "log", "text": "Gained experience based on level!" }
      ]
    },
    "bomb": {
      "name": "Bomb",
      "stackable": true,
      "start_count": 1,
      "use_effects": [
        { "type": "log", "text": "BOOM! Deals damage based on strength and intelligence." }
      ]
    }
  },
  "buffs": {
    "power_boost": {
      "desc": "Increases physical damage",
      "value_expr": "0",
      "modifiers": [
        { "type": "stat_add", "stat": "strength", "value_expr": "$value" }
      ]
    },
    "magic_boost": {
      "desc": "Increases magical power",
      "value_expr": "0",
      "modifiers": [
        { "type": "stat_add", "stat": "intelligence", "value_expr": "$value" }
      ]
    },
    "armor_boost": {
      "desc": "Increases armor",
      "value_expr": "0",
      "modifiers": [
        { "type": "stat_add", "stat": "armor", "value_expr": "$value" }
      ]
    },
    "mp_regen": {
      "desc": "Regenerate MP each day",
      "value_expr": "0",
      "periodic": {
        "every": "day",
        "effects": [
          { "type": "stat_add", "stat": "mp", "value_expr": "$value * 2" },
          { "type": "log", "text": "MP regenerated from amulet." }
        ]
      }
    },
    "damage_reduction": {
      "desc": "Reduces incoming damage",
      "value_expr": "0"
    },
    "curse": {
      "desc": "Drains HP each day",
      "value_expr": "0",
      "periodic": {
        "every": "day",
        "effects": [
          { "type": "stat_add", "stat": "hp", "value_expr": "-$value" },
          { "type": "log", "text": "The curse drains your life..." }
        ]
      }
    },
    "luck": {
      "desc": "Increases luck for checks",
      "value_expr": "0"
    },
    "berserk": {
      "desc": "Double strength but halve armor",
      "value_expr": "1",
      "modifiers": [
        { "type": "stat_add", "stat": "strength", "value_expr": "$stat.strength.cur" },
        { "type": "stat_add", "stat": "armor", "value_expr": "-floor($stat.armor.cur / 2)" }
      ]
    },
    "shield_wall": {
      "desc": "Triple armor temporarily",
      "value_expr": "1",
      "modifiers": [
        { "type": "stat_add", "stat": "armor", "value_expr": "$stat.armor.cur * 2" }
      ]
    },
    "arcane_surge": {
      "desc": "Intelligence boost based on MP ratio",
      "value_expr": "1",
      "modifiers": [
        { "type": "stat_add", "stat": "intelligence", "value_expr": "floor(($stat.mp.cur / $stat.mp.max) * 10)" }
      ]
    },
    "xp_boost": {
      "desc": "Experience multiplier",
      "value_expr": "1.5"
    }
  },
  "shops": {
    "blacksmith": {
      "name": "Blacksmith",
      "items": [
        {
          "id": "power_ring",
          "price": 50,
          "conditions": ["$stat.gold.cur >= 50"],
          "effects": [
            { "type": "stat_add", "stat": "gold", "value_expr": "-50" },
            { "type": "item_add", "item": "power_ring", "count_expr": "1" },
            { "type": "log", "text": "Bought Power Ring." }
          ]
        },
        {
          "id": "guardian_shield",
          "price": 80,
          "conditions": ["$stat.gold.cur >= 80", "!hasItem('guardian_shield', 1)"],
          "effects": [
            { "type": "stat_add", "stat": "gold", "value_expr": "-80" },
            { "type": "item_add", "item": "guardian_shield", "count_expr": "1" },
            { "type": "log", "text": "Bought Guardian Shield." }
          ]
        },
        {
          "id": "cursed_blade",
          "price": 30,
          "conditions": ["$stat.gold.cur >= 30", "!hasItem('cursed_blade', 1)"],
          "effects": [
            { "type": "stat_add", "stat": "gold", "value_expr": "-30" },
            { "type": "item_add", "item": "cursed_blade", "count_expr": "1" },
            { "type": "log", "text": "The cursed blade is now yours..." }
          ]
        }
      ]
    },
    "alchemist": {
      "name": "Alchemist",
      "items": [
        {
          "id": "health_potion",
          "price": 15,
          "conditions": ["$stat.gold.cur >= 15"],
          "effects": [
            { "type": "stat_add", "stat": "gold", "value_expr": "-15" },
            { "type": "item_add", "item": "health_potion", "count_expr": "1" }
          ]
        },
        {
          "id": "mana_potion",
          "price": 20,
          "conditions": ["$stat.gold.cur >= 20"],
          "effects": [
            { "type": "stat_add", "stat": "gold", "value_expr": "-20" },
            { "type": "item_add", "item": "mana_potion", "count_expr": "1" }
          ]
        },
        {
          "id": "magic_amulet",
          "price": 60,
          "conditions": ["$stat.gold.cur >= 60"],
          "effects": [
            { "type": "stat_add", "stat": "gold", "value_expr": "-60" },
            { "type": "item_add", "item": "magic_amulet", "count_expr": "1" }
          ]
        },
        {
          "id": "experience_tome",
          "price": 40,
          "conditions": ["$stat.gold.cur >= 40"],
          "effects": [
            { "type": "stat_add", "stat": "gold", "value_expr": "-40" },
            { "type": "item_add", "item": "experience_tome", "count_expr": "1" }
          ]
        }
      ]
    }
  },
  "events": [
    {
      "trigger": "on_day_start",
      "effects": [
        { "type": "log", "text": "A new day begins." }
      ]
    },
    {
      "trigger": "on_day_start",
      "conditions": ["$stat.xp.cur >= $stat.level.cur * 100"],
      "effects": [
        { "type": "stat_add", "stat": "level", "value_expr": "1" },
        { "type": "stat_add", "stat": "hp", "value_expr": "10" },
        { "type": "stat_add_max", "stat": "hp", "value_expr": "10" },
        { "type": "stat_add", "stat": "mp", "value_expr": "5" },
        { "type": "stat_add_max", "stat": "mp", "value_expr": "5" },
        { "type": "stat_set", "stat": "xp", "value_expr": "$stat.xp.cur - $stat.level.cur * 100 + 100" },
        { "type": "log", "text": "LEVEL UP! HP and MP increased." }
      ]
    },
    {
      "trigger": "on_day_start",
      "conditions": ["$stat.hp.cur < floor($stat.hp.max * 0.25)"],
      "effects": [
        { "type": "log", "text": "Warning: Health critically low!" }
      ]
    }
  ],
  "story": {
    "start": "hub",
    "nodes": {
      "hub": {
        "title": "Town Square",
        "text": "You stand in the bustling town square. Various shops and adventures await.",
        "shops": ["blacksmith", "alchemist"],
        "choices": [
          {
            "text": "Enter the dungeon",
            "effects": [{ "type": "goto", "node": "dungeon_entrance" }]
          },
          {
            "text": "Train at the arena",
            "effects": [{ "type": "goto", "node": "arena" }]
          },
          {
            "text": "Go berserk! (requires Strength > 12)",
            "conditions": ["$stat.strength.cur > 12", "!hasBuff('berserk')"],
            "effects": [
              { "type": "buff_add", "buff": "berserk", "value_expr": "1" },
              { "type": "log", "text": "RAAAAGH! Strength doubled, armor halved!" }
            ]
          },
          {
            "text": "Raise shield wall (requires Shield)",
            "conditions": ["hasItem('guardian_shield', 1)", "!hasBuff('shield_wall')"],
            "effects": [
              { "type": "buff_add", "buff": "shield_wall", "value_expr": "1" },
              { "type": "log", "text": "Shield wall raised! Armor tripled!" }
            ]
          },
          {
            "text": "Arcane surge (requires MP > 50%)",
            "conditions": ["$stat.mp.cur > $stat.mp.max / 2", "!hasBuff('arcane_surge')"],
            "effects": [
              { "type": "buff_add", "buff": "arcane_surge", "value_expr": "1" },
              { "type": "stat_add", "stat": "mp", "value_expr": "-floor($stat.mp.cur / 2)" },
              { "type": "log", "text": "Arcane power surges through you!" }
            ]
          },
          {
            "text": "Rest for the day",
            "effects": [
              { "type": "stat_add", "stat": "hp", "value_expr": "floor($stat.hp.max * 0.1)" },
              { "type": "stat_add", "stat": "mp", "value_expr": "floor($stat.mp.max * 0.2)" },
              { "type": "advance_day", "value_expr": "1" }
            ]
          }
        ]
      },
      "arena": {
        "title": "Training Arena",
        "text": "A grizzled warrior offers to spar with you.",
        "choices": [
          {
            "text": "Strength challenge (STR check)",
            "check": {
              "name": "Strength Test",
              "roll_expr": "roll('1d20')",
              "base_expr": "floor(($stat.strength.cur - 10) / 2)",
              "buff_expr": "($buff.power_boost ?? 0) + ($buff.luck ?? 0)",
              "dc": 15,
              "bands": {
                "crit_fail": { "range": "1" },
                "crit_success": { "range": "20" }
              },
              "crit_success": {
                "effects": [
                  { "type": "stat_add", "stat": "xp", "value_expr": "50 * ($buff.xp_boost ?? 1)" },
                  { "type": "stat_add", "stat": "gold", "value_expr": "20" },
                  { "type": "log", "text": "CRITICAL! Devastating performance!" }
                ]
              },
              "success": {
                "effects": [
                  { "type": "stat_add", "stat": "xp", "value_expr": "floor(30 * ($buff.xp_boost ?? 1))" },
                  { "type": "stat_add", "stat": "gold", "value_expr": "10" },
                  { "type": "log", "text": "You won the strength challenge!" }
                ]
              },
              "fail": {
                "effects": [
                  { "type": "stat_add", "stat": "hp", "value_expr": "-floor($stat.hp.max * 0.1)" },
                  { "type": "stat_add", "stat": "xp", "value_expr": "floor(10 * ($buff.xp_boost ?? 1))" },
                  { "type": "log", "text": "You lost but gained some experience." }
                ]
              },
              "crit_fail": {
                "effects": [
                  { "type": "stat_add", "stat": "hp", "value_expr": "-floor($stat.hp.max * 0.2)" },
                  { "type": "log", "text": "CRITICAL FAILURE! Badly injured!" }
                ]
              }
            }
          },
          {
            "text": "Magic challenge (INT check)",
            "check": {
              "name": "Magic Test",
              "roll_expr": "roll('1d20')",
              "base_expr": "floor(($stat.intelligence.cur - 10) / 2)",
              "buff_expr": "($buff.magic_boost ?? 0) + ($buff.luck ?? 0)",
              "dc": 14,
              "bands": {
                "crit_fail": { "range": "1" },
                "crit_success": { "range": "20" }
              },
              "success": {
                "effects": [
                  { "type": "stat_add", "stat": "xp", "value_expr": "floor(25 * ($buff.xp_boost ?? 1))" },
                  { "type": "stat_add", "stat": "mp", "value_expr": "5" },
                  { "type": "log", "text": "Your magical prowess impressed everyone!" }
                ]
              },
              "fail": {
                "effects": [
                  { "type": "stat_add", "stat": "mp", "value_expr": "-10" },
                  { "type": "stat_add", "stat": "xp", "value_expr": "floor(5 * ($buff.xp_boost ?? 1))" },
                  { "type": "log", "text": "The spell fizzled..." }
                ]
              }
            }
          },
          {
            "text": "Combined challenge (STR + INT)",
            "check": {
              "name": "Combined Test",
              "roll_expr": "roll('2d10')",
              "base_expr": "floor((($stat.strength.cur + $stat.intelligence.cur) / 2 - 10) / 2)",
              "buff_expr": "floor((($buff.power_boost ?? 0) + ($buff.magic_boost ?? 0)) / 2) + ($buff.luck ?? 0)",
              "dc": 16,
              "success": {
                "effects": [
                  { "type": "stat_add", "stat": "xp", "value_expr": "floor(40 * ($buff.xp_boost ?? 1))" },
                  { "type": "stat_add", "stat": "gold", "value_expr": "15" },
                  { "type": "log", "text": "Perfect balance of strength and magic!" }
                ]
              },
              "fail": {
                "effects": [
                  { "type": "stat_add", "stat": "hp", "value_expr": "-5" },
                  { "type": "stat_add", "stat": "mp", "value_expr": "-5" },
                  { "type": "log", "text": "Failed to balance both disciplines." }
                ]
              }
            }
          },
          {
            "text": "Return to town",
            "effects": [{ "type": "goto", "node": "hub" }]
          }
        ]
      },
      "dungeon_entrance": {
        "title": "Dungeon Entrance",
        "text": "A dark cave looms before you. Strange sounds echo from within.",
        "choices": [
          {
            "text": "Fight the goblin (uses Bomb if available)",
            "check": {
              "name": "Goblin Fight",
              "roll_expr": "roll('1d20')",
              "base_expr": "floor(($stat.strength.cur - 10) / 2) + (hasItem('bomb', 1) ? 5 : 0)",
              "buff_expr": "($buff.power_boost ?? 0) - ($buff.damage_reduction ?? 0)",
              "dc": 12,
              "success": {
                "effects": [
                  { "type": "stat_add", "stat": "xp", "value_expr": "20 + $stat.level.cur * 5" },
                  { "type": "stat_add", "stat": "gold", "value_expr": "floor(15 + random() * 10)" },
                  { "type": "log", "text": "Goblin defeated! Gained gold and experience." },
                  { "type": "goto", "node": "dungeon_deep" }
                ]
              },
              "fail": {
                "effects": [
                  { "type": "stat_add", "stat": "hp", "value_expr": "-max(1, 10 - ($buff.armor_boost ?? 0) - ($buff.damage_reduction ?? 0))" },
                  { "type": "log", "text": "The goblin wounded you!" }
                ]
              }
            }
          },
          {
            "text": "Sneak past (DEX check using average of STR and INT)",
            "check": {
              "name": "Sneak",
              "roll_expr": "roll('1d20')",
              "base_expr": "floor((min($stat.strength.cur, $stat.intelligence.cur) - 10) / 2)",
              "buff_expr": "$buff.luck ?? 0",
              "dc": 14,
              "success": {
                "effects": [
                  { "type": "stat_add", "stat": "xp", "value_expr": "15" },
                  { "type": "log", "text": "You slip past unnoticed." },
                  { "type": "goto", "node": "dungeon_deep" }
                ]
              },
              "fail": {
                "effects": [
                  { "type": "log", "text": "Detected! The goblin attacks!" },
                  { "type": "stat_add", "stat": "hp", "value_expr": "-5" }
                ]
              }
            }
          },
          {
            "text": "Return to town",
            "effects": [{ "type": "goto", "node": "hub" }]
          }
        ]
      },
      "dungeon_deep": {
        "title": "Deep Dungeon",
        "text": "You've reached the heart of the dungeon. A treasure chest gleams in the darkness.",
        "choices": [
          {
            "text": "Open the chest (trap check)",
            "check": {
              "name": "Trap Check",
              "roll_expr": "roll('1d20')",
              "base_expr": "floor(($stat.intelligence.cur - 10) / 2)",
              "buff_expr": "($buff.luck ?? 0) * 2",
              "dc": 13,
              "bands": {
                "crit_fail": { "range": "1-2" },
                "crit_success": { "range": "19-20" }
              },
              "crit_success": {
                "effects": [
                  { "type": "stat_add", "stat": "gold", "value_expr": "100 + $stat.level.cur * 20" },
                  { "type": "item_add", "item": "lucky_coin", "count_expr": "1" },
                  { "type": "stat_add", "stat": "xp", "value_expr": "floor(80 * ($buff.xp_boost ?? 1))" },
                  { "type": "log", "text": "JACKPOT! Found a fortune and a lucky coin!" },
                  { "type": "goto", "node": "hub" }
                ]
              },
              "success": {
                "effects": [
                  { "type": "stat_add", "stat": "gold", "value_expr": "50 + floor($stat.level.cur * 10)" },
                  { "type": "stat_add", "stat": "xp", "value_expr": "floor(40 * ($buff.xp_boost ?? 1))" },
                  { "type": "log", "text": "Found treasure!" },
                  { "type": "goto", "node": "hub" }
                ]
              },
              "fail": {
                "effects": [
                  { "type": "stat_add", "stat": "hp", "value_expr": "-floor($stat.hp.max * 0.15)" },
                  { "type": "stat_add", "stat": "gold", "value_expr": "20" },
                  { "type": "log", "text": "Triggered a trap! But still got some gold." },
                  { "type": "goto", "node": "hub" }
                ]
              },
              "crit_fail": {
                "effects": [
                  { "type": "stat_add", "stat": "hp", "value_expr": "-floor($stat.hp.max * 0.3)" },
                  { "type": "stat_add", "stat": "gold", "value_expr": "-floor($stat.gold.cur * 0.1)" },
                  { "type": "log", "text": "DISASTER! Severe trap damage and lost gold!" },
                  { "type": "goto", "node": "hub" }
                ]
              }
            }
          },
          {
            "text": "Leave carefully",
            "effects": [
              { "type": "stat_add", "stat": "xp", "value_expr": "10" },
              { "type": "goto", "node": "hub" }
            ]
          }
        ]
      },
      "end_dead": {
        "type": "ending",
        "title": "Death",
        "text": "Your adventure ends here..."
      },
      "end_rich": {
        "type": "ending",
        "title": "Wealthy Adventurer",
        "text": "You amassed a fortune and retired in comfort!"
      }
    }
  },
  "endings": [
    { "id": "dead", "conditions": ["$stat.hp.cur <= 0"], "node": "end_dead" },
    { "id": "rich", "conditions": ["$stat.gold.cur >= 500", "$stat.level.cur >= 3"], "node": "end_rich" }
  ]
}
